# Example Dockerfile for Railway when using Docker instead of Nixpacks.
# To use: copy this file to the repo root as "Dockerfile" and set railway.toml:
#   [build]
#   builder = "DOCKERFILE"
#   dockerfilePath = "Dockerfile"

FROM node:20-alpine
WORKDIR /app

ARG DEPLOY_THEME_SLUG
ARG VITE_API_BASE_URL
ARG RAILWAY_PUBLIC_DOMAIN
ARG GOOGLE_CLOUD_TRANSLATION_API_KEY
ARG VITE_GOOGLE_CLOUD_TRANSLATION_API_KEY

ENV DEPLOY_THEME_SLUG=${DEPLOY_THEME_SLUG}
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
ENV RAILWAY_PUBLIC_DOMAIN=${RAILWAY_PUBLIC_DOMAIN}
ENV GOOGLE_CLOUD_TRANSLATION_API_KEY=${GOOGLE_CLOUD_TRANSLATION_API_KEY}
ENV VITE_GOOGLE_CLOUD_TRANSLATION_API_KEY=${VITE_GOOGLE_CLOUD_TRANSLATION_API_KEY}

COPY package*.json ./
RUN npm install
COPY . .

RUN npm run build:production

RUN if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then \
      echo "ERROR: Build failed - dist directory is empty or missing" && exit 1; \
    fi

EXPOSE 4173

RUN chmod +x scripts/entrypoint.js scripts/start-production.js scripts/serve-theme-static.js

CMD ["node", "scripts/start-production.js"]
