---
import '~/assets/styles/tailwind.css';

import { I18N } from 'astrowind:config';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import ApplyColorMode from '~/components/common/ApplyColorMode.astro';
import Metadata from '~/components/common/Metadata.astro';
import SiteVerification from '~/components/common/SiteVerification.astro';
import Analytics from '~/components/common/Analytics.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';

// Comment the line below to disable View Transitions
import { ClientRouter } from 'astro:transitions';

import type { MetaData as MetaDataType } from '~/types';

export interface Props {
  metadata?: MetaDataType;
  branding?: {
    siteName?: string | null;
    siteTagline?: string | null;
    logoSrc?: string | null;
    faviconSrc?: string | null;
  };
}

const { metadata = {}, branding: propsBranding } = Astro.props;
const { language, textDirection } = I18N;

// Tenant-aware branding - fetch if not provided via props
let branding = propsBranding;
if (!branding) {
  const tenantId = Astro.request.headers.get('x-tenant-id') || Astro.url.searchParams.get('tenantId') || '';
  const baseUrl = new URL(Astro.request.url);

  try {
    const res = await fetch(
      new URL(`/api/v1/theme/masterastrowind/branding?tenantId=${encodeURIComponent(tenantId)}`, baseUrl),
      { headers: tenantId ? { 'X-Tenant-Id': tenantId } : undefined }
    );
    const json = await res.json();
    const fetchedBranding = json?.data || null;
    
    if (fetchedBranding) {
      branding = {
        siteName: fetchedBranding.site_name || 'Master Astrowind',
        siteTagline: fetchedBranding.site_tagline || 'Free template for creating websites with Astro + Tailwind CSS',
        logoSrc: fetchedBranding.site_logo || null,
        faviconSrc: fetchedBranding.site_favicon || null,
      };
    }
  } catch {
    // Fallback to defaults
  }
}

const siteName = branding?.siteName || 'Master Astrowind';
const siteTagline = branding?.siteTagline || 'Free template for creating websites with Astro + Tailwind CSS';
const logoSrc = branding?.logoSrc || null;
const faviconSrc = branding?.faviconSrc || null;
---

<!doctype html>
<html lang={language} dir={textDirection} class="2xl:text-[20px]">
  <head>
    <CommonMeta />
    <Favicons faviconSrc={faviconSrc} />
    <CustomStyles />
    <ApplyColorMode />
    <Metadata {...metadata} />
    <SiteVerification />
    <Analytics />

    <!-- Comment the line below to disable View Transitions -->
    <ClientRouter fallback="swap" />
  </head>

  <body class="antialiased text-default bg-page tracking-tight">
    <slot />

    <BasicScripts />
  </body>
</html>
